var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

function _objectWithoutProperties(obj, keys) { var target = {}; for (var i in obj) { if (keys.indexOf(i) >= 0) continue; if (!Object.prototype.hasOwnProperty.call(obj, i)) continue; target[i] = obj[i]; } return target; }

import _ from 'lodash';
import React, { useEffect, useCallback, useState } from 'react';
import { Formik } from 'formik';
import Element from './Element';
import { SchemaProvider } from './withFormConfig';
import { prepareValidationSchema } from './utils';
import Rules from '@flipbyte/yup-schema';

var FormikForm = function FormikForm(_ref) {
    var onUpdate = _ref.onUpdate,
        schema = _ref.schema,
        formik = _objectWithoutProperties(_ref, ['onUpdate', 'schema']);

    /**
     * Callback if provided will be vcalled when form values change
     */
    useEffect(function () {
        if (typeof onUpdate === 'function') {
            onUpdate(formik);
        }
    }, [formik.values]);

    return React.createElement(Element, { config: schema });
};

var Form = React.forwardRef(function (_ref2, ref) {
    var schema = _ref2.schema,
        _ref2$onUpdate = _ref2.onUpdate,
        onUpdate = _ref2$onUpdate === undefined ? function () {} : _ref2$onUpdate,
        _ref2$initialValues = _ref2.initialValues,
        initialValues = _ref2$initialValues === undefined ? {} : _ref2$initialValues,
        rest = _objectWithoutProperties(_ref2, ['schema', 'onUpdate', 'initialValues']);

    var _useState = useState(null),
        validationSchema = _useState[0],
        setValidationSchema = _useState[1];

    /**
     * Initialize validation schema.
     *
     * Convert the validation schema rules from yup-schema array to yup object
     */


    var initValidationSchema = useCallback(function () {
        var yupSchema = prepareValidationSchema(schema);
        var validationSchema = !_.isEmpty(yupSchema) ? new Rules([['object', yupSchema]]).toYup() : null;
        setValidationSchema(validationSchema);
    }, [schema]);

    /**
     * Everytime the schema changes, re-initialize validationSchema
     *
     * This is has to be done everytime schema changes because,
     * certain cases may involve dynamically changing form fields based on
     * certain conditions, routes etc.
     */
    useEffect(function () {
        initValidationSchema();
    }, [schema]);

    var formProps = _extends({}, rest, { initialValues: initialValues });
    if (null !== validationSchema) {
        formProps.validationSchema = validationSchema;
    }

    return React.createElement(
        SchemaProvider,
        { value: { validationSchema: validationSchema, schema: schema } },
        React.createElement(
            Formik,
            _extends({}, formProps, {
                innerRef: ref
            }),
            function (props) {
                return React.createElement(FormikForm, _extends({
                    onUpdate: onUpdate,
                    schema: schema
                }, props));
            }
        )
    );
});

export default Form;